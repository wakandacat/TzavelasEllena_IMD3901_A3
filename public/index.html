<!DOCTYPE html>
<html>
    <head>
      <title>A3</title>
      <meta name="description" content="Snowball">
      <!--aframe-->
      <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
      <!--environment library-->
      <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
      <!--physics library
      <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
      -->
      <script src="/socket.io/socket.io.js"></script>
      <!--custom js components-->

      <!--css-->
      <link rel="stylesheet" href="css/styles.css">
    </head>

    <body>
       <!--all a-frame stuff needs to be in an a-scene-->
       <a-scene start-experience create-balls> 

        <!--aframe uses an asset system to cache assets-->
        <a-assets timeout="10000">
      
          <!--music/sounds-->
        </a-assets>

        <!--camera-->
        <a-entity id="cam" camera wasd-controls look-controls position="0 1.6 0">
            <!--cursor-->
            <a-entity id="mouse" cursor="rayOrigin:mouse;" raycaster="far:5; interval:200; objects: .interactive;"></a-entity>      
        </a-entity>
        
        <!--environment-->
        <a-entity environment="preset: threetowers; fog: 0.75; shadow: true;"></a-entity>

      </a-scene>


      <!--start screen to wait for user gesture-->
      <div id="user-gesture-overlay">
        <div id="container">
            <button id="circle-blue" class="start-circles" onclick="startSelection('circle-blue')">
            </button>
            <button id="circle-red" class="start-circles" onclick="startSelection('circle-red')">
            </button>
          <img id="loading-animation" src="https://cdn.glitch.com/4d85200f-900f-4f4a-b950-82c4af80c1fb%2Floader.gif?v=1611262527887">
        </div>
        <button class="user-gesture-button">
          <p>START</p>
        </button>
      </div>

      <div id="UI">
        <div>
          <button id="player1" class="ui-circles">
            1
            <h3 id="enemyText1">Matches:</h3>
          </button>
        </div>
        <div>
          <h1 id="teamText">PLAYERS CONNECTED: 1</h1>
          <h1 id="collabText">Matches: </h1>
        </div>
        <div>
          <button id="player2" class="ui-circles">
            2
            <h3 id="enemyText2">Matches:</h3>
          </button>
        </div>
      </div>

       <!--end screen-->
       <div id="end-overlay">
        <div id="container">
            <h1>GAME OVER</h1>
        </div>
      </div>


      <script>
        //globals
        var player1Col = "#53e043";
        var player2Col = "#d938c6";
        var isCollab = true;
        var numBalls = 12; //hardcoded as dont want to send too much data over the network
        var ballCols = [[66, 245, 227], [131, 232, 125], [204, 51, 31], [83, 31, 161], [247, 121, 191], [237, 235, 81]]; //hardcoded as dont want to send too much data over the network

        //hide end-game screen
        document.querySelector("#end-overlay").style.display = "none";


         let socket = io(); //connect this client

          socket.on('connect', (userData) => {
              console.log('Hello there');


            //event to send final user choice to server
            document.querySelector('.user-gesture-button').addEventListener('click', function(e) {
             // console.log("ending");
             //get the final selected colour of the user
              var finalColour = document.querySelector(".selected");
              if(finalColour.id == "circle-red"){
                  finalColour = "red";
              } else {
                finalColour = "blue";
              }
              //disable the button
              document.querySelector('.user-gesture-button').disabled = true;

              socket.emit('finalChoice', finalColour);
            })

            //event to determine teams
            socket.on('teams', (data) => {
                console.log('teams: ' + data);

                //show the waiting text
                document.querySelector('#teamText').style.display='block';

               if(data.includes("red") && data.includes("blue")){
                  isCollab = false;
               } else {
                  isCollab = true;
               }
               //check that we have two responses
               if(data.length >= 6){
                  startExperience();
               }
            });

            //send event
            document.querySelector('#circle-blue').addEventListener('click', function(e) {
                socket.emit('blue', socket.id);
            })

            //send event
            document.querySelector('#circle-red').addEventListener('click', function(e) {
                socket.emit('red', socket.id);
            })

            //listen for our custom colour change event
            socket.on('circleChoice', (data) => {
                console.log('circleChoice: ' + data);
                var temp = String(data);
                //if event was from other client
                if(temp.includes(socket.id) != true){
                  if(temp.includes("red")){
                    //change the outlines
                    var otherCirc = document.querySelector("#circle-red");
                    var selected = document.querySelector("#circle-blue");
                    otherCirc.style.outlineColor = player2Col;
                    selected.style.outlineColor = "white";
                 
                  } else {
                    //change the outlines
                    var otherCirc = document.querySelector("#circle-blue");
                    var selected = document.querySelector("#circle-red");
                    otherCirc.style.outlineColor = player2Col;
                    selected.style.outlineColor = "white";
                  }
                }
            });

          });

          AFRAME.registerComponent('start-experience', {
          init: function () {
            //we can't play sound on some browsers until we have some user interaction
            //this means we should only start playing ambient music after this button is clicked
            console.log('scene loaded');
            document.querySelector('#loading-animation').style.display='none';
          }
        });

        AFRAME.registerComponent('create-balls', {
          init: function () {

            var scene = document.querySelector('a-scene');
            var numCol = 0;

            for(let i = 0; i < numBalls; i++){
              //get random positioning values
              var randX = (Math.random() < 0.5 ? -1 : 1);
              randX = randX * (Math.floor(Math.random() * 20));
              var randY = Math.floor(Math.random() * 3) + 1;
              var randZ = (Math.random() < 0.5 ? -1 : 1);
              randZ = randZ * (Math.floor(Math.random() * 20));

              //every 2 balls need a new colour
              if(i%2 === 0 && i !== 0){
                numCol++;
              }

              var currentR = ballCols[numCol][0];
              var currentG = ballCols[numCol][1];
              var currentB = ballCols[numCol][2];

              //create the balls
              var ball = document.createElement('a-entity');
              ball.setAttribute('id', `${i}`);
              ball.setAttribute('class', 'ball interactive');
              ball.setAttribute('geometry', {primitive: 'sphere'},{radius: '1'});
              ball.setAttribute('material', {color: `rgb(${currentR}, ${currentG}, ${currentB})`});
              ball.setAttribute('position', `${randX}, ${randY}, ${randZ}`);
              ball.setAttribute('selected', "");
              scene.appendChild(ball); //append it to the scene

              //create the balls
              var selectBall = document.createElement('a-entity');
              selectBall.setAttribute('id', `select${i}`);
              selectBall.setAttribute('visible', 'false');
              selectBall.setAttribute('geometry', {primitive: 'sphere'},{radius: 1});
              selectBall.setAttribute('scale', '0.2 0.2 0.2');
              selectBall.setAttribute('position', '0, 1.5, 0');
              ball.appendChild(selectBall); //append it to the scene
            }

          },
          tick: function(){
            
            var numSelected = 0;
            var numPaired = 0;
            var scene = document.querySelector('a-scene');

            for(let i = 0; i < numBalls; i++){
              
              if(document.querySelector(`#select${i}`).getAttribute('visible') == true){
                numSelected++;
              }

              //if both the current ball and its pair are selected
              if(i%2 === 0){
                if(document.querySelector(`#select${i}`).getAttribute('visible') == true && document.querySelector(`#select${i+1}`).getAttribute('visible') == true){
                  numPaired++;
                  if(!isCollab){
                    document.querySelector("#enemyText1").innerHTML = "Matches: " + numPaired;
                  }
                }
              }
         
            if(numSelected === 12){
              scene.removeAttribute('create-balls');
              gameEnd();
            }

            }
          },
        });

        function gameEnd(){

          document.querySelector("#teamText").style.display = "none";
          document.querySelector("#end-overlay").style.display = "block";

        }

        //change the colours of the circle borders as the user presses them
        function startSelection(id){

          //show the start button
          document.querySelector('.user-gesture-button').style.display='block';

          //get the button that was pressed
          var selectedCirc = document.querySelector("[id=" + CSS.escape(id) + "]");
          selectedCirc.classList.add("selected");
          selectedCirc.style.borderColor = player1Col;

          //ensure the other circle is not pressed
          if(id.includes("blue")){
            var otherCirc = document.querySelector("#circle-red");
            otherCirc.style.borderColor = "white";

            if(otherCirc.classList.contains("selected")){
              otherCirc.classList.remove("selected");
            }
          } else {
            var otherCirc = document.querySelector("#circle-blue");
            otherCirc.style.borderColor = "white";

            if(otherCirc.classList.contains("selected")){
              otherCirc.classList.remove("selected");
            }
          }
        }

        //once both users have selected a team, the game begins
        function startExperience() {
          //hide user-gesture overlay
           document.querySelector('#user-gesture-overlay').style.display='none';
           var instructions = document.querySelector('#teamText');
           if(isCollab){
            instructions.innerHTML = "MATCH COLOUR PAIRS!";
            document.querySelector('#collabText').style.display = 'block';
           } else {
            instructions.innerHTML = "MATCH MORE COLOUR PAIRS THAN YOUR ENEMY!";
            document.querySelector('#enemyText1').style.display = 'block';
            document.querySelector('#enemyText2').style.display = 'block';
           }
        }


        AFRAME.registerComponent('selected', {
          init: function () {
            
            var el = this.el;
            var elCol = el.getAttribute('material').color;
            var scene = document.querySelector('a-scene');

            //the mouseover changes the colour of the ball
            el.addEventListener('mouseenter', function () {
                
              el.removeAttribute('material', 'color');
              el.setAttribute('material','color', 'white');
                 
            });

            //when mouse leaves change the colour back
            el.addEventListener('mouseleave', function () {
                
                el.removeAttribute('material', 'color');
                el.setAttribute('material','color', `${elCol}`);
                   
            });

            //once the ball is clicked "thrown"
            el.addEventListener('click', function () {
               
              //get the corresponding smaller circle
              var connectedSelect = document.querySelector(`#select${el.getAttribute('id')}`);
              connectedSelect.setAttribute('material', 'color', `${player1Col}`);
              connectedSelect.setAttribute('visible', true);
              el.removeAttribute('class', 'interactive');
              el.removeAttribute('selected');
           });            
            
          }
        });

      </script>

    </body>

</html>